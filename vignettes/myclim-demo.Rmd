---
title: "myClim: microclimatic data in R"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{myClim demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
This vignette describes the handling of microclimatic data in R with myClim library. myClim workflow begin at the reading data primary from microclimatic dataloggers but can be also reding of meteorological station data from files. Cleaning time step, time zone settings and metadata collecting is the next step of the workflow. Microclimatic data are stored in mcClim objects of regular R structure consists of classes and lists slightly resembling database scheme. #(see my-clim package)#
With myClim tools one can crop, join, downscale, and convert microclimatic data form and format, sort them into localities, call descriptive characteristics and compute microclimatic derivates. Handy plotting functions are provided with smart defaults.   

## Install

```{r eval=FALSE}
# Install dependencies

requiered_packages <- c("stringr", "lubridate", "tibble",
                        "dplyr", "purrr", "ggplot2", "ggforce",
                        "viridis", "runner")
missing_packages <- requiered_packages[!(requiered_packages %in% installed.packages()[,"Package"])]
if(length(missing_packages)) install.packages(missing_packages)

# directory to unzip source files
dir.create("c:\\Users\\Doga\\Downloads\\microclim0.25")
setwd("c:\\Users\\Doga\\Downloads\\microclim0.25")

zip_file <- "myClim.zip"
dir_name <- "myClim"
download.file("https://git.sorbus.ibot.cas.cz/api/v4/projects/microclimate_r%2Fmicroclim/repository/archive.zip?ref=HEAD&private_token=2fmZB-Qg-fbiVvzz2-Lh", destfile=zip_file, mode="wb")
subdir <- unzip(zip_file, list=TRUE)$Name[1]
unzip(zip_file)
file.remove(zip_file)
unlink(dir_name, recursive=TRUE)
file.rename(subdir, dir_name)
setwd(dir_name)
pkg_file <- devtools::build(".")
install.packages(pkg_file, repos = NULL)


library(myClim)
browseVignettes("myClim")

```

## Input data files
Letâ€™s say we have microclimatic data from the filed data loggers. It can be single file from single datalogger hosting single or multiple sensors.  It can be few csv files downloaded once or multiple times from single locality hosting single or multiple dataloggers. It can be many files from many localities downloaded just once or any combination of all mentioned. This can be load into r to single myClim object file by file or file directories. Besides loading csv files myClim object can be created also from tidy wide or long tables from R environment. This is useful in case you already have miroclimatic time series in R and when query microclimatic data form database. 


## Read microclimatic data
myClim read multiple formats of data downloaded from various loggers (for testing only Tomst format is supported, but we are preparing also HOBO, ibutton, lascar etc) read functions require downloaded data in defined format as is specific column order, separator, date format, number format atc. Logger output files are specified in R class with several slots. User can principially extend supported file formats defining custom class. See `mc_DataFormat-class` While reading data, user must specify `dataformat_name=` one of `r names(myClim::mc_data_formats)`. For testing supported only Tomst files. 
 
When user not provide metadata and localities, using functions `mc_read_files()`, `mc_read_wide()`, `mc_read_long()` myClim automatically generates localities from each data file. Such localities are named after loaded data files (loggers) or locality from wide, long format and have no metadata.
When user provides metadata using function `mc_read_data()` than two specific tables are required. 1. table with logger files paths, logger type and locality, 2. table with locality metadata like e.g. coordinates, altitude, time zone information. See help for `mc_read_data()`

After reading, created myClim object is in Prep-format. See `help("myClim")`.

```{r eval=FALSE}
# setwd("..")
library(myClim)
setwd("..")
setwd("d:/Git/myClim/")

## Read without metadata
# read from files, no metadata provided
tms.f <- mc_read_files(c("d:/Git/myClim/examples/data/TOMST/data_91184101_0.csv",
                         "d:/Git/myClim/examples/data/TOMST/data_94184102_0.csv"),
                       dataformat_name="TOMST")


# read from directory, no metadata
tms.d <- mc_read_files(c("d:/Git/myClim/examples/"), dataformat_name="TOMST")
# warning about file format control, files not matching foramt are skipped. 
airTmax$date[1]

# read from data.frame, no metadata
load("d:/Git/myClim/examples/data/chmi/airTmax_merged.RData") #airTmax
airTmax$date<-as.POSIXct(airTmax$date,tz="UTC")
meteo<-mc_read_wide(airTmax,sensor_id = "T_C", sensor_name = "airTmax")


## Read with metadata
# provide one table with file paths and one with locality metadata
tms.f <- mc_read_data(files_table = "d:/Git/myClim/examples/data/TOMST/files_table.csv",
                      localities_table = "d:/Git/myClim/examples/data/TOMST/localities_table.csv")

```


## Data cleaning and wrangling


```{r}

```

